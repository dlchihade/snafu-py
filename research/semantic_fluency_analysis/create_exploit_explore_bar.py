#!/usr/bin/env python3
"""
Create a clean, publication-style bar figure comparing mean exploitation vs exploration
cosine similarity from output/NATURE_REAL_metrics.csv.
"""

from pathlib import Path
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from scipy import stats

from create_nature_quality_figures_real import setup_nature_style


def main() -> None:
    base = Path(__file__).parent
    metrics_path = base / 'output' / 'NATURE_REAL_metrics.csv'
    if not metrics_path.exists():
        raise FileNotFoundError(f"Missing metrics file: {metrics_path}")

    df = pd.read_csv(metrics_path)
    # Drop rows missing key columns
    cols = ['exploitation_intra_mean', 'exploration_intra_mean']
    df = df.dropna(subset=cols)
    exploit_vals = df['exploitation_intra_mean'].to_numpy(dtype=float)
    explore_vals = df['exploration_intra_mean'].to_numpy(dtype=float)
    n = len(df)
    if n == 0:
        raise ValueError("No rows available after dropping missing values.")
    diff_vec = exploit_vals - explore_vals
    diff_mean = float(np.mean(diff_vec))
    diff_sd = float(np.std(diff_vec, ddof=1)) if n > 1 else 0.0
    cohen_d = diff_mean / diff_sd if diff_sd > 0 else float('nan')
    try:
        t_stat, p_val = stats.ttest_rel(exploit_vals, explore_vals)
    except Exception:
        t_stat, p_val = float('nan'), float('nan')

    # Compute mean and 95% CI for both metrics
    bar_stats = []
    for label, col in [('Exploitation', 'exploitation_intra_mean'),
                       ('Exploration', 'exploration_intra_mean')]:
        vals = df[col].to_numpy(dtype=float)
        mu = float(np.mean(vals))
        sd = float(np.std(vals, ddof=1)) if len(vals) > 1 else 0.0
        se = sd / np.sqrt(len(vals)) if len(vals) > 0 else 0.0
        ci95 = 1.96 * se
        bar_stats.append({'label': label, 'mean': mu, 'sd': sd, 'ci95': ci95})
    bar_stats.sort(key=lambda s: s['mean'], reverse=True)

    # Style
    palette = setup_nature_style()
    plt.rcParams.update({
        'font.size': 9.5,
        'axes.titlesize': 11,
        'axes.labelsize': 10,
        'xtick.labelsize': 9,
        'ytick.labelsize': 9,
        'savefig.dpi': 600,
    })
    colors = {'Exploitation': palette['secondary'], 'Exploration': palette['accent']}

    # Figure
    fig, ax = plt.subplots(figsize=(4.2, 2.6))
    y = np.arange(len(bar_stats))
    means = [s['mean'] for s in bar_stats]
    ci = [s['ci95'] for s in bar_stats]
    labels = [s['label'] for s in bar_stats]
    bar_colors = [colors[l] for l in labels]

    bars = ax.barh(y, means, xerr=ci, capsize=4, color=bar_colors, height=0.6)
    for yi, m, ci_val in zip(y, means, ci):
        ax.text(m + ci_val + 0.02, yi, f"{m:.3f}",
                va='center', ha='left', fontsize=10)

    ax.set_yticks(y, labels)
    ax.set_xlabel('Mean cosine similarity (± 95% CI)')
    max_x = max(m + c for m, c in zip(means, ci))
    upper = max(0.8, max_x + 0.05)
    ax.set_xlim(0, upper)
    ax.set_xticks(np.linspace(0, upper, 5))
    ax.set_title(f'Exploitation vs Exploration (N = {n})')
    ax.grid(axis='x', alpha=0.25)
    for spine in ['bottom', 'left']:
        ax.spines[spine].set_color(palette['neutral'])
    ax.spines['left'].set_linewidth(0.6)
    ax.spines['bottom'].set_linewidth(0.6)

    fig.subplots_adjust(bottom=0.28)
    footer = 'Bars show mean ± 95% CI'
    stats_text = f'Δ = {diff_mean:.3f} | t = {t_stat:.2f} | p = {p_val:.3e} | d = {cohen_d:.2f}'
    fig.text(0.02, 0.04, footer, ha='left', va='bottom', fontsize=8.5, color=palette['neutral'])
    fig.text(0.98, 0.04, stats_text, ha='right', va='bottom', fontsize=8.5, color=palette['neutral'])

    out_dir = base / 'output'
    out_dir.mkdir(parents=True, exist_ok=True)
    out_png = out_dir / 'exploit_explore_bar.png'
    out_pdf = out_dir / 'exploit_explore_bar.pdf'
    fig.savefig(out_png)
    fig.savefig(out_pdf)
    plt.close(fig)
    print(f"✅ Wrote {out_png}\n✅ Wrote {out_pdf}")


if __name__ == '__main__':
    main()


