#!/usr/bin/env python3
"""
Compose Supplemental Explorationâ€“Exploitation figure with minimal redundancy:
- Panel A: spacy_matrix_only.png (correlogram + colorbar)
- Panel B: spacy_vs_alternatives_publication_D.png (bar chart, no title)
Saves PNG and PDF with consistent margins and gap.
"""
from pathlib import Path
from PIL import Image, ImageDraw, ImageFont


def stack_images(top_path: Path, bottom_path: Path, out_png: Path, out_pdf: Path,
                 gap_px: int = 20, margin_px: int = 28):
    top = Image.open(top_path).convert('RGB')
    bot = Image.open(bottom_path).convert('RGB')

    # Match widths by scaling bottom to top width
    target_w = top.width
    scale = target_w / bot.width
    bot = bot.resize((target_w, int(bot.height * scale)))

    canvas_w = target_w + 2 * margin_px
    canvas_h = top.height + bot.height + gap_px + 2 * margin_px
    canvas = Image.new('RGB', (canvas_w, canvas_h), color=(255, 255, 255))

    x = margin_px
    y_top = margin_px
    y_bot = y_top + top.height + gap_px
    canvas.paste(top, (x, y_top))
    canvas.paste(bot, (x, y_bot))

    # Panel labels
    draw = ImageDraw.Draw(canvas)
    try:
        font = ImageFont.load_default()
    except Exception:
        font = None
    draw.text((x + 2, y_top + 2), 'A', fill=(0, 0, 0), font=font)
    draw.text((x + 2, y_bot + 2), 'B', fill=(0, 0, 0), font=font)

    out_png.parent.mkdir(exist_ok=True)
    canvas.save(out_png)
    # Save as PDF as well
    canvas.save(out_pdf)


def main():
    base = Path('output')
    top = base / 'spacy_matrix_only.png'
    bottom = base / 'spacy_vs_alternatives_publication_D.png'
    out_png = base / 'supplemental_exploration_exploitation.png'
    out_pdf = base / 'supplemental_exploration_exploitation.pdf'

    if not top.exists() or not bottom.exists():
        raise FileNotFoundError('Required inputs missing. Run spacy_matrix_only.py and split_spacy_publication.py first.')

    stack_images(top, bottom, out_png, out_pdf)
    print('Saved supplemental figure:')
    print(f' - {out_png}')
    print(f' - {out_pdf}')


if __name__ == '__main__':
    main()

